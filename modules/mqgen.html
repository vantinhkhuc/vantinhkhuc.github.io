<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodle Question Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #e5e7eb;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }
        
        .editor-panel, .preview-panel {
            padding: 30px;
        }
        
        .editor-panel {
            border-right: 2px solid #e0e0e0;
        }
        
        .panel-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title::before {
            content: '‚úèÔ∏è';
        }
        
        .preview-panel .panel-title::before {
            content: 'üëÅÔ∏è';
        }
        
        textarea {
            width: 100%;
            height: 400px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .preview-content {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .question-preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .question-type {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        
        .question-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .question-text {
            color: #555;
            line-height: 1.6;
            margin: 15px 0;
        }
        
        .answer-option {
            padding: 10px 15px;
            margin: 8px 0;
            background: #f3f4f6;
            border-radius: 6px;
            border-left: 3px solid #d1d5db;
        }
        
        .answer-option.correct {
            background: #d1fae5;
            border-left-color: #10b981;
        }
        
        .help-section {
            background: #fff7ed;
            border: 2px solid #fed7aa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 30px;
        }
        
        .help-title {
            font-size: 1.3em;
            color: #ea580c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .help-title::before {
            content: 'üìñ';
        }
        
        .example-code {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
            white-space: pre;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            padding: 20px 30px;
            background: #f9fafb;
            border-top: 2px solid #e5e7eb;
        }
        
        .stat-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .error-message {
            background: #fee2e2;
            border: 2px solid #fca5a5;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .validation-box {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .validation-item {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            align-items: start;
            gap: 10px;
        }
        
        .validation-item.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
        }
        
        .validation-item.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .validation-item.error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        
        .validation-icon {
            font-size: 1.2em;
            flex-shrink: 0;
        }
        
        .visual-editor {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .answer-list {
            margin-top: 15px;
        }
        
        .answer-item {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .answer-item input[type="text"] {
            flex: 1;
        }
        
        .answer-item input[type="number"] {
            width: 80px;
        }
        
        .answer-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-add {
            background: #10b981;
            color: white;
            margin-top: 10px;
        }
        
        .btn-add:hover {
            background: #059669;
        }
        
        .editor-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }
        
        .question-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
        }
        
        .question-list-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .question-list-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .question-list-item.selected {
            border-color: #667eea;
            background: #f0f9ff;
        }
        
        .question-list-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        
        .match-pair {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .match-arrow {
            font-size: 1.5em;
            color: #667eea;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Moodle Question Generator</h1>
            <p>Chuy·ªÉn ƒë·ªïi Markdown th√†nh Moodle XML format - H·ªó tr·ª£ t·∫•t c·∫£ lo·∫°i c√¢u h·ªèi</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('markdown')">üìù Markdown Editor</div>
            <div class="tab" onclick="switchTab('visual')">üé® Visual Editor</div>
        </div>
        
        <div id="markdownTab" class="tab-content active">
        
        <div class="main-content">
            <div class="editor-panel">
                <h2 class="panel-title">Markdown Input</h2>
                <textarea id="markdownInput" placeholder="Nh·∫≠p c√¢u h·ªèi theo ƒë·ªãnh d·∫°ng Markdown...">## Multiple Choice
# Question: Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† g√¨?
- H√† N·ªôi [100%]
- H·ªì Ch√≠ Minh
- ƒê√† N·∫µng
- Hu·∫ø

## True/False
# Question: Tr√°i ƒë·∫•t h√¨nh c·∫ßu
- True [100%]
- False

## Short Answer
# Question: Ai l√† t√°c gi·∫£ c·ªßa "Truy·ªán Ki·ªÅu"?
= Nguy·ªÖn Du [100%]
= Nguyen Du [100%]

## Numerical
# Question: 2 + 2 = ?
= 4 [100%]

## Matching
# Question: Gh√©p c√°c c·∫∑p sau
@ Th·ªß ƒë√¥ Vi·ªát Nam -> H√† N·ªôi
@ Th·ªß ƒë√¥ Th√°i Lan -> Bangkok
@ Th·ªß ƒë√¥ Nh·∫≠t B·∫£n -> Tokyo</textarea>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="parseMarkdown()">üîÑ Parse & Preview</button>
                    <button class="btn-success" onclick="exportXML()">üì• Export XML</button>
                    <button class="btn-secondary" onclick="clearAll()">üóëÔ∏è Clear</button>
                    <button class="btn-secondary" onclick="loadExample()">üìù Load Example</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border: 2px dashed #0284c7; border-radius: 8px;">
                    <label for="fileInput" style="display: block; margin-bottom: 10px; font-weight: 600; color: #0369a1;">
                        üìÅ Import Markdown File:
                    </label>
                    <input type="file" id="fileInput" accept=".md,.txt" onchange="handleFileUpload(event)" 
                           style="padding: 8px; border: 1px solid #0284c7; border-radius: 6px; background: white; width: 100%;">
                </div>
                
                <div id="validationResults" style="margin-top: 20px;"></div>
            </div>
            
            <div class="preview-panel">
                <h2 class="panel-title">Preview</h2>
                <div class="preview-content" id="preview">
                    <p style="color: #9ca3af; text-align: center; padding: 50px 20px;">
                        Nh·∫≠p markdown v√† nh·∫•n "Parse & Preview" ƒë·ªÉ xem tr∆∞·ªõc c√¢u h·ªèi
                    </p>
                </div>
            </div>
        </div>
        </div>
        
        <div id="visualTab" class="tab-content">
            <div class="main-content">
                <div class="visual-editor">
                    <h2 class="panel-title">Create/Edit Question</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Question Type</label>
                        <select id="questionType" class="form-select" onchange="updateEditorFields()">
                            <option value="multichoice">Multiple Choice</option>
                            <option value="truefalse">True/False</option>
                            <option value="shortanswer">Short Answer</option>
                            <option value="numerical">Numerical</option>
                            <option value="matching">Matching</option>
                            <option value="essay">Essay</option>
                            <option value="description">Description</option>
                            <option value="calculated">Calculated</option>
                            <option value="calculatedsimple">Simple Calculated</option>
                            <option value="cloze">Cloze (Embedded Answers)</option>
                            <option value="ordering">Ordering</option>
                            <option value="ddwtos">Drag and Drop into Text</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Question Text *</label>
                        <textarea id="questionText" class="form-input form-textarea" placeholder="Enter your question here..."></textarea>
                    </div>
                    
                    <div id="answersSection" class="form-group">
                        <label class="form-label">Answers</label>
                        <div id="answersList" class="answer-list">
                            <!-- Answers will be added here dynamically -->
                        </div>
                        <button class="btn-small btn-add" onclick="addAnswer()">+ Add Answer</button>
                    </div>
                    
                    <div id="matchingSection" class="form-group" style="display: none;">
                        <label class="form-label">Matching Pairs</label>
                        <div id="matchingList" class="answer-list">
                            <!-- Matching pairs will be added here -->
                        </div>
                        <button class="btn-small btn-add" onclick="addMatchPair()">+ Add Match Pair</button>
                    </div>
                    
                    <div id="orderingSection" class="form-group" style="display: none;">
                        <label class="form-label">Items to Order</label>
                        <div id="orderingList" class="answer-list">
                            <!-- Ordering items will be added here -->
                        </div>
                        <button class="btn-small btn-add" onclick="addOrderItem()">+ Add Item</button>
                    </div>
                    
                    <div id="calculatedSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Formula (use {a}, {b}, etc.)</label>
                            <input type="text" id="formulaInput" class="form-input" placeholder="e.g., {a} * {b}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dataset (format: var=min:max:step)</label>
                            <input type="text" id="datasetInput" class="form-input" placeholder="e.g., a=5:15:1, b=3:10:1">
                        </div>
                    </div>
                    
                    <div id="ddwtosSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Choices (comma separated)</label>
                            <input type="text" id="choicesInput" class="form-input" placeholder="e.g., Python, JavaScript, HTML">
                        </div>
                    </div>
                    
                    <div class="editor-actions">
                        <button class="btn-primary" onclick="saveQuestion()">üíæ Save Question</button>
                        <button class="btn-secondary" onclick="clearEditor()">üîÑ Clear</button>
                        <button class="btn-success" onclick="exportFromVisual()">üì• Export All to XML</button>
                    </div>
                </div>
                
                <div class="preview-panel">
                    <h2 class="panel-title">Question List</h2>
                    <div id="questionListContainer" class="question-list">
                        <p style="color: #9ca3af; text-align: center; padding: 30px;">No questions yet. Create your first question!</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalQuestions">0</div>
                <div class="stat-label">T·ªïng s·ªë c√¢u h·ªèi</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="questionTypes">0</div>
                <div class="stat-label">Lo·∫°i c√¢u h·ªèi</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="validQuestions">0</div>
                <div class="stat-label">C√¢u h·ªèi h·ª£p l·ªá</div>
            </div>
        </div>
        
        <div class="help-section">
            <h3 class="help-title">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
            <p><strong>C√∫ ph√°p Markdown:</strong></p>
            <div class="example-code">## [Question Type]
# Question: [N·ªôi dung c√¢u h·ªèi]
- [ƒê√°p √°n] [Grade%]    (Multiple Choice)
= [ƒê√°p √°n] [Grade%]    (Short Answer, Numerical)
@ [Item] -> [Match]    (Matching)</div>
            
            <p style="margin-top: 15px;"><strong>C√°c lo·∫°i c√¢u h·ªèi ƒë∆∞·ª£c h·ªó tr·ª£:</strong></p>
            <p>Multiple Choice, True/False, Short Answer, Numerical, Matching, Essay, Description, Calculated, Simple Calculated, Drag and drop (into text, markers, onto image), Embedded Answers (Cloze), Ordering, Select missing words, v.v.</p>
            
            <p style="margin-top: 15px;"><strong>C√∫ ph√°p n√¢ng cao:</strong></p>
            <div class="example-code">## Calculated
# Question: T√≠nh di·ªán t√≠ch h√¨nh ch·ªØ nh·∫≠t v·ªõi chi·ªÅu d√†i {a} v√† chi·ªÅu r·ªông {b}
# Formula: {a} * {b}
# Dataset: a=5:10:1, b=3:8:1

## Cloze (Embedded Answers)  
# Question: Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† {:SHORTANSWER:=H√† N·ªôi}

## Drag and Drop into Text
# Question: K√©o t·ª´ v√†o ch·ªó tr·ªëng: Ng√¥n ng·ªØ [[1]] ƒë∆∞·ª£c d√πng cho [[2]]
# Choices: Python, Web Development, Machine Learning

## Ordering
# Question: S·∫Øp x·∫øp c√°c b∆∞·ªõc theo th·ª© t·ª±
> Ph√¢n t√≠ch y√™u c·∫ßu
> Thi·∫øt k·∫ø h·ªá th·ªëng  
> Coding
> Testing</div>
        </div>
    </div>

    <script>
        let parsedQuestions = [];
        let validationResults = [];
        let visualQuestions = [];
        let currentEditingIndex = -1;

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tabName === 'markdown') {
                document.getElementById('markdownTab').classList.add('active');
            } else {
                document.getElementById('visualTab').classList.add('active');
                updateQuestionList();
            }
        }

        // Visual Editor Functions
        function updateEditorFields() {
            const type = document.getElementById('questionType').value;
            
            // Hide all dynamic sections
            document.getElementById('answersSection').style.display = 'none';
            document.getElementById('matchingSection').style.display = 'none';
            document.getElementById('orderingSection').style.display = 'none';
            document.getElementById('calculatedSection').style.display = 'none';
            document.getElementById('ddwtosSection').style.display = 'none';
            
            // Show relevant sections based on type
            if (['multichoice', 'truefalse', 'shortanswer', 'numerical'].includes(type)) {
                document.getElementById('answersSection').style.display = 'block';
                initializeAnswers(type);
            } else if (type === 'matching') {
                document.getElementById('matchingSection').style.display = 'block';
                initializeMatching();
            } else if (type === 'ordering') {
                document.getElementById('orderingSection').style.display = 'block';
                initializeOrdering();
            } else if (['calculated', 'calculatedsimple'].includes(type)) {
                document.getElementById('calculatedSection').style.display = 'block';
            } else if (type === 'ddwtos') {
                document.getElementById('ddwtosSection').style.display = 'block';
            }
        }

        function initializeAnswers(type) {
            const container = document.getElementById('answersList');
            container.innerHTML = '';
            
            if (type === 'truefalse') {
                addAnswerField('True', 100);
                addAnswerField('False', 0);
            } else {
                addAnswerField('', 100);
                addAnswerField('', 0);
            }
        }

        function addAnswer() {
            const type = document.getElementById('questionType').value;
            const defaultGrade = type === 'shortanswer' || type === 'numerical' ? 100 : 0;
            addAnswerField('', defaultGrade);
        }

        function addAnswerField(text = '', grade = 0) {
            const container = document.getElementById('answersList');
            const answerId = 'answer_' + Date.now() + '_' + Math.random();
            
            const type = document.getElementById('questionType').value;
            const isMultiChoice = type === 'multichoice' || type === 'truefalse';
            
            const div = document.createElement('div');
            div.className = 'answer-item';
            div.innerHTML = `
                <input type="text" class="form-input" placeholder="Answer text" value="${text}" data-answer-id="${answerId}">
                ${isMultiChoice ? 
                    `<input type="checkbox" ${grade > 0 ? 'checked' : ''} title="Correct answer" data-answer-id="${answerId}">
                     <span style="width: 60px; text-align: center;">${grade}%</span>` :
                    `<input type="number" class="form-input" placeholder="Grade %" value="${grade}" min="0" max="100" data-answer-id="${answerId}">`
                }
                <button class="btn-small btn-danger" onclick="this.parentElement.remove()">‚úï</button>
            `;
            container.appendChild(div);
        }

        function initializeMatching() {
            const container = document.getElementById('matchingList');
            container.innerHTML = '';
            addMatchPair();
            addMatchPair();
            addMatchPair();
        }

        function addMatchPair() {
            const container = document.getElementById('matchingList');
            const div = document.createElement('div');
            div.className = 'match-pair';
            div.innerHTML = `
                <input type="text" class="form-input" placeholder="Question/Item" style="flex: 1;">
                <span class="match-arrow">‚Üí</span>
                <input type="text" class="form-input" placeholder="Answer/Match" style="flex: 1;">
                <button class="btn-small btn-danger" onclick="this.parentElement.remove()">‚úï</button>
            `;
            container.appendChild(div);
        }

        function initializeOrdering() {
            const container = document.getElementById('orderingList');
            container.innerHTML = '';
            addOrderItem();
            addOrderItem();
            addOrderItem();
        }

        function addOrderItem() {
            const container = document.getElementById('orderingList');
            const div = document.createElement('div');
            div.className = 'answer-item';
            div.innerHTML = `
                <span style="width: 30px; text-align: center; font-weight: bold;">${container.children.length + 1}.</span>
                <input type="text" class="form-input" placeholder="Item text" style="flex: 1;">
                <button class="btn-small btn-danger" onclick="this.parentElement.remove(); updateOrderNumbers();">‚úï</button>
            `;
            container.appendChild(div);
        }

        function updateOrderNumbers() {
            const container = document.getElementById('orderingList');
            Array.from(container.children).forEach((item, index) => {
                item.querySelector('span').textContent = (index + 1) + '.';
            });
        }

        function saveQuestion() {
            const type = document.getElementById('questionType').value;
            const text = document.getElementById('questionText').value.trim();
            
            if (!text) {
                alert('Please enter question text!');
                return;
            }
            
            const question = {
                type: type,
                name: text.substring(0, 50),
                text: text,
                answers: [],
                matches: [],
                ordering: [],
                formula: '',
                dataset: '',
                choices: [],
                defaultGrade: 1
            };
            
            // Collect answers
            if (['multichoice', 'truefalse', 'shortanswer', 'numerical'].includes(type)) {
                const answerItems = document.querySelectorAll('#answersList .answer-item');
                answerItems.forEach(item => {
                    const textInput = item.querySelector('input[type="text"]');
                    const text = textInput.value.trim();
                    if (!text) return;
                    
                    let grade;
                    if (type === 'multichoice' || type === 'truefalse') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        grade = checkbox.checked ? 100 : 0;
                    } else {
                        const gradeInput = item.querySelector('input[type="number"]');
                        grade = parseInt(gradeInput.value) || 0;
                    }
                    
                    question.answers.push({ text, grade });
                });
            }
            
            // Collect matching pairs
            if (type === 'matching') {
                const matchPairs = document.querySelectorAll('#matchingList .match-pair');
                matchPairs.forEach(pair => {
                    const inputs = pair.querySelectorAll('input');
                    const q = inputs[0].value.trim();
                    const a = inputs[1].value.trim();
                    if (q && a) {
                        question.matches.push({ question: q, answer: a });
                    }
                });
            }
            
            // Collect ordering items
            if (type === 'ordering') {
                const items = document.querySelectorAll('#orderingList .answer-item input');
                items.forEach(input => {
                    const text = input.value.trim();
                    if (text) question.ordering.push(text);
                });
            }
            
            // Collect calculated data
            if (type === 'calculated' || type === 'calculatedsimple') {
                question.formula = document.getElementById('formulaInput').value.trim();
                question.dataset = document.getElementById('datasetInput').value.trim();
            }
            
            // Collect drag and drop choices
            if (type === 'ddwtos') {
                const choicesText = document.getElementById('choicesInput').value.trim();
                question.choices = choicesText.split(',').map(c => c.trim()).filter(c => c);
            }
            
            // Add or update question
            if (currentEditingIndex >= 0) {
                visualQuestions[currentEditingIndex] = question;
                currentEditingIndex = -1;
            } else {
                visualQuestions.push(question);
            }
            
            updateQuestionList();
            clearEditor();
            alert('Question saved successfully!');
        }

        function updateQuestionList() {
            const container = document.getElementById('questionListContainer');
            
            if (visualQuestions.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 30px;">No questions yet. Create your first question!</p>';
                return;
            }
            
            let html = '';
            visualQuestions.forEach((q, index) => {
                html += `<div class="question-list-item" onclick="editQuestion(${index})">
                    <strong>${index + 1}. ${q.type.toUpperCase()}</strong>
                    <div style="color: #6b7280; margin-top: 5px;">${q.text.substring(0, 100)}${q.text.length > 100 ? '...' : ''}</div>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #9ca3af;">
                        ${q.answers.length > 0 ? `${q.answers.length} answers` : ''}
                        ${q.matches.length > 0 ? `${q.matches.length} pairs` : ''}
                        ${q.ordering.length > 0 ? `${q.ordering.length} items` : ''}
                    </div>
                    <button class="btn-small btn-danger" style="margin-top: 10px;" onclick="deleteQuestion(${index}, event)">Delete</button>
                </div>`;
            });
            
            container.innerHTML = html;
            
            // Update stats
            document.getElementById('totalQuestions').textContent = visualQuestions.length;
            const types = new Set(visualQuestions.map(q => q.type));
            document.getElementById('questionTypes').textContent = types.size;
            document.getElementById('validQuestions').textContent = visualQuestions.length;
        }

        function editQuestion(index) {
            currentEditingIndex = index;
            const q = visualQuestions[index];
            
            document.getElementById('questionType').value = q.type;
            document.getElementById('questionText').value = q.text;
            
            updateEditorFields();
            
            // Populate answers
            if (q.answers.length > 0) {
                const container = document.getElementById('answersList');
                container.innerHTML = '';
                q.answers.forEach(a => addAnswerField(a.text, a.grade));
            }
            
            // Populate matching
            if (q.matches.length > 0) {
                const container = document.getElementById('matchingList');
                container.innerHTML = '';
                q.matches.forEach(m => {
                    addMatchPair();
                    const lastPair = container.lastElementChild;
                    const inputs = lastPair.querySelectorAll('input');
                    inputs[0].value = m.question;
                    inputs[1].value = m.answer;
                });
            }
            
            // Populate ordering
            if (q.ordering.length > 0) {
                const container = document.getElementById('orderingList');
                container.innerHTML = '';
                q.ordering.forEach(item => {
                    addOrderItem();
                    const lastItem = container.lastElementChild;
                    lastItem.querySelector('input').value = item;
                });
            }
            
            // Populate calculated
            if (q.formula) document.getElementById('formulaInput').value = q.formula;
            if (q.dataset) document.getElementById('datasetInput').value = q.dataset;
            
            // Populate choices
            if (q.choices.length > 0) {
                document.getElementById('choicesInput').value = q.choices.join(', ');
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteQuestion(index, event) {
            event.stopPropagation();
            if (confirm('Are you sure you want to delete this question?')) {
                visualQuestions.splice(index, 1);
                updateQuestionList();
            }
        }

        function clearEditor() {
            currentEditingIndex = -1;
            document.getElementById('questionType').value = 'multichoice';
            document.getElementById('questionText').value = '';
            document.getElementById('formulaInput').value = '';
            document.getElementById('datasetInput').value = '';
            document.getElementById('choicesInput').value = '';
            updateEditorFields();
        }

        function exportFromVisual() {
            if (visualQuestions.length === 0) {
                alert('No questions to export!');
                return;
            }
            
            parsedQuestions = visualQuestions;
            const xml = generateMoodleXML();
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'moodle_questions.xml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('markdownInput').value = e.target.result;
                parseMarkdown();
            };
            reader.readAsText(file);
        }

        function parseMarkdown() {
            const input = document.getElementById('markdownInput').value;
            parsedQuestions = [];
            validationResults = [];
            
            const sections = input.split(/^##\s+/m).filter(s => s.trim());
            
            sections.forEach((section, index) => {
                const lines = section.trim().split('\n');
                const typeMatch = lines[0].match(/^(.+?)$/);
                if (!typeMatch) return;
                
                const type = typeMatch[1].trim();
                let question = {
                    type: normalizeQuestionType(type),
                    name: '',
                    text: '',
                    answers: [],
                    matches: [],
                    feedback: '',
                    defaultGrade: 1,
                    formula: '',
                    dataset: '',
                    choices: [],
                    ordering: []
                };
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Question text
                    if (line.startsWith('# Question:')) {
                        question.text = line.replace('# Question:', '').trim();
                        question.name = question.text.substring(0, 50);
                    }
                    // Formula for Calculated questions
                    else if (line.startsWith('# Formula:')) {
                        question.formula = line.replace('# Formula:', '').trim();
                    }
                    // Dataset for Calculated questions
                    else if (line.startsWith('# Dataset:')) {
                        question.dataset = line.replace('# Dataset:', '').trim();
                    }
                    // Choices for Drag and Drop
                    else if (line.startsWith('# Choices:')) {
                        question.choices = line.replace('# Choices:', '').split(',').map(c => c.trim());
                    }
                    // Multiple choice answer
                    else if (line.startsWith('- ')) {
                        const answerText = line.substring(2).trim();
                        const gradeMatch = answerText.match(/\[(\d+)%\]$/);
                        const text = answerText.replace(/\[\d+%\]$/, '').trim();
                        const grade = gradeMatch ? parseInt(gradeMatch[1]) : 0;
                        question.answers.push({ text, grade });
                    }
                    // Short answer / Numerical
                    else if (line.startsWith('= ')) {
                        const answerText = line.substring(2).trim();
                        const gradeMatch = answerText.match(/\[(\d+)%\]$/);
                        const text = answerText.replace(/\[\d+%\]$/, '').trim();
                        const grade = gradeMatch ? parseInt(gradeMatch[1]) : 100;
                        question.answers.push({ text, grade });
                    }
                    // Matching
                    else if (line.startsWith('@ ')) {
                        const matchText = line.substring(2).trim();
                        const parts = matchText.split('->').map(p => p.trim());
                        if (parts.length === 2) {
                            question.matches.push({ question: parts[0], answer: parts[1] });
                        }
                    }
                    // Ordering
                    else if (line.startsWith('> ')) {
                        question.ordering.push(line.substring(2).trim());
                    }
                }
                
                if (question.text) {
                    parsedQuestions.push(question);
                    validateQuestion(question, index + 1);
                }
            });
            
            displayPreview();
            displayValidation();
            updateStats();
        }

        function validateQuestion(question, number) {
            const issues = [];
            
            // Check question text
            if (!question.text || question.text.length < 5) {
                issues.push({
                    type: 'error',
                    message: `C√¢u ${number}: N·ªôi dung c√¢u h·ªèi qu√° ng·∫Øn ho·∫∑c thi·∫øu`
                });
            }
            
            // Validate based on question type
            switch(question.type) {
                case 'multichoice':
                case 'truefalse':
                    if (question.answers.length < 2) {
                        issues.push({
                            type: 'error',
                            message: `C√¢u ${number}: C·∫ßn √≠t nh·∫•t 2 ƒë√°p √°n cho Multiple Choice`
                        });
                    }
                    
                    const hasCorrect = question.answers.some(a => a.grade > 0);
                    if (!hasCorrect) {
                        issues.push({
                            type: 'error',
                            message: `C√¢u ${number}: Kh√¥ng c√≥ ƒë√°p √°n ƒë√∫ng (c·∫ßn √≠t nh·∫•t 1 ƒë√°p √°n c√≥ grade > 0)`
                        });
                    }
                    
                    const totalGrade = question.answers.reduce((sum, a) => sum + a.grade, 0);
                    if (totalGrade !== 100) {
                        issues.push({
                            type: 'warning',
                            message: `C√¢u ${number}: T·ªïng ƒëi·ªÉm c√°c ƒë√°p √°n l√† ${totalGrade}% (n√™n l√† 100%)`
                        });
                    }
                    break;
                    
                case 'shortanswer':
                case 'numerical':
                    if (question.answers.length === 0) {
                        issues.push({
                            type: 'error',
                            message: `C√¢u ${number}: C·∫ßn √≠t nh·∫•t 1 ƒë√°p √°n ƒë√∫ng`
                        });
                    }
                    break;
                    
                case 'matching':
                    if (question.matches.length < 3) {
                        issues.push({
                            type: 'warning',
                            message: `C√¢u ${number}: N√™n c√≥ √≠t nh·∫•t 3 c·∫∑p matching`
                        });
                    }
                    break;
                    
                case 'calculated':
                    if (!question.formula) {
                        issues.push({
                            type: 'error',
                            message: `C√¢u ${number}: Thi·∫øu c√¥ng th·ª©c (# Formula:)`
                        });
                    }
                    if (!question.dataset) {
                        issues.push({
                            type: 'warning',
                            message: `C√¢u ${number}: Thi·∫øu dataset (# Dataset:)`
                        });
                    }
                    break;
                    
                case 'ordering':
                    if (question.ordering.length < 2) {
                        issues.push({
                            type: 'error',
                            message: `C√¢u ${number}: C·∫ßn √≠t nh·∫•t 2 items ƒë·ªÉ s·∫Øp x·∫øp`
                        });
                    }
                    break;
            }
            
            if (issues.length === 0) {
                validationResults.push({
                    type: 'success',
                    message: `C√¢u ${number}: ‚úì H·ª£p l·ªá (${question.type})`
                });
            } else {
                validationResults.push(...issues);
            }
        }

        function displayValidation() {
            const container = document.getElementById('validationResults');
            
            if (validationResults.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div class="validation-box"><h3 style="margin-bottom: 15px; color: #333;">üìã Validation Results</h3>';
            
            validationResults.forEach(result => {
                const icon = result.type === 'success' ? '‚úì' : result.type === 'warning' ? '‚ö†' : '‚úó';
                html += `<div class="validation-item ${result.type}">
                    <span class="validation-icon">${icon}</span>
                    <span>${result.message}</span>
                </div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function normalizeQuestionType(type) {
            const typeMap = {
                'multiple choice': 'multichoice',
                'multichoice': 'multichoice',
                'true/false': 'truefalse',
                'truefalse': 'truefalse',
                'short answer': 'shortanswer',
                'shortanswer': 'shortanswer',
                'numerical': 'numerical',
                'matching': 'matching',
                'essay': 'essay',
                'description': 'description',
                'calculated': 'calculated',
                'simple calculated': 'calculatedsimple',
                'calculatedsimple': 'calculatedsimple',
                'cloze': 'cloze',
                'embedded answers': 'cloze',
                'ordering': 'ordering',
                'drag and drop': 'ddimageortext',
                'drag and drop into text': 'ddwtos',
                'ddwtos': 'ddwtos',
                'drag and drop markers': 'ddmarker',
                'drag and drop onto image': 'ddimageortext',
                'select missing words': 'gapselect',
                'gapselect': 'gapselect'
            };
            
            const normalized = type.toLowerCase().trim();
            return typeMap[normalized] || 'multichoice';
        }

        function displayPreview() {
            const preview = document.getElementById('preview');
            
            if (parsedQuestions.length === 0) {
                preview.innerHTML = '<div class="error-message">Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng Markdown.</div>';
                return;
            }
            
            let html = '';
            parsedQuestions.forEach((q, index) => {
                html += `<div class="question-preview">
                    <span class="question-type">${q.type.toUpperCase()}</span>
                    <div class="question-name">C√¢u ${index + 1}: ${q.name}</div>
                    <div class="question-text">${q.text}</div>`;
                
                // Display formula for calculated questions
                if (q.formula) {
                    html += `<div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px;">
                        <strong>Formula:</strong> ${q.formula}
                    </div>`;
                }
                
                if (q.dataset) {
                    html += `<div style="margin-top: 5px; padding: 10px; background: #fef3c7; border-radius: 6px;">
                        <strong>Dataset:</strong> ${q.dataset}
                    </div>`;
                }
                
                // Display choices for drag and drop
                if (q.choices.length > 0) {
                    html += `<div style="margin-top: 10px; padding: 10px; background: #f3f4f6; border-radius: 6px;">
                        <strong>Choices:</strong> ${q.choices.join(', ')}
                    </div>`;
                }
                
                // Display ordering items
                if (q.ordering.length > 0) {
                    html += '<div style="margin-top: 15px;"><strong>Order:</strong>';
                    q.ordering.forEach((item, i) => {
                        html += `<div class="answer-option">${i + 1}. ${item}</div>`;
                    });
                    html += '</div>';
                }
                
                if (q.answers.length > 0) {
                    html += '<div style="margin-top: 15px;">';
                    q.answers.forEach(a => {
                        const isCorrect = a.grade > 0 ? 'correct' : '';
                        html += `<div class="answer-option ${isCorrect}">
                            ${a.text} ${a.grade > 0 ? `(${a.grade}%)` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                if (q.matches.length > 0) {
                    html += '<div style="margin-top: 15px;">';
                    q.matches.forEach(m => {
                        html += `<div class="answer-option">${m.question} ‚û°Ô∏è ${m.answer}</div>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            preview.innerHTML = html;
        }

        function updateStats() {
            document.getElementById('totalQuestions').textContent = parsedQuestions.length;
            const types = new Set(parsedQuestions.map(q => q.type));
            document.getElementById('questionTypes').textContent = types.size;
            document.getElementById('validQuestions').textContent = parsedQuestions.filter(q => q.text && (q.answers.length > 0 || q.matches.length > 0 || q.type === 'essay' || q.type === 'description')).length;
        }

        function escapeXml(text) {
            return text.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&apos;');
        }

        function generateMoodleXML() {
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<quiz>\n';
            
            parsedQuestions.forEach(q => {
                xml += `  <question type="${q.type}">\n`;
                xml += `    <name><text>${escapeXml(q.name)}</text></name>\n`;
                xml += `    <questiontext format="html">\n`;
                xml += `      <text><![CDATA[<p>${escapeXml(q.text)}</p>]]></text>\n`;
                xml += `    </questiontext>\n`;
                xml += `    <generalfeedback format="html"><text></text></generalfeedback>\n`;
                xml += `    <defaultgrade>${q.defaultGrade}</defaultgrade>\n`;
                xml += `    <penalty>0.1</penalty>\n`;
                xml += `    <hidden>0</hidden>\n`;
                
                if (q.type === 'multichoice' || q.type === 'truefalse') {
                    xml += `    <single>true</single>\n`;
                    xml += `    <shuffleanswers>true</shuffleanswers>\n`;
                    xml += `    <answernumbering>abc</answernumbering>\n`;
                    
                    q.answers.forEach(a => {
                        const fraction = a.grade;
                        xml += `    <answer fraction="${fraction}" format="html">\n`;
                        xml += `      <text><![CDATA[${escapeXml(a.text)}]]></text>\n`;
                        xml += `    </answer>\n`;
                    });
                }
                
                if (q.type === 'shortanswer' || q.type === 'numerical') {
                    q.answers.forEach(a => {
                        const fraction = a.grade;
                        xml += `    <answer fraction="${fraction}" format="moodle_auto_format">\n`;
                        xml += `      <text>${escapeXml(a.text)}</text>\n`;
                        xml += `    </answer>\n`;
                    });
                }
                
                if (q.type === 'matching') {
                    xml += `    <shuffleanswers>1</shuffleanswers>\n`;
                    q.matches.forEach(m => {
                        xml += `    <subquestion format="html">\n`;
                        xml += `      <text><![CDATA[${escapeXml(m.question)}]]></text>\n`;
                        xml += `      <answer><text>${escapeXml(m.answer)}</text></answer>\n`;
                        xml += `    </subquestion>\n`;
                    });
                }
                
                xml += `  </question>\n`;
            });
            
            xml += '</quiz>';
            return xml;
        }

        function exportXML() {
            if (parsedQuestions.length === 0) {
                alert('Vui l√≤ng parse markdown tr∆∞·ªõc khi export!');
                return;
            }
            
            const xml = generateMoodleXML();
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'moodle_questions.xml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearAll() {
            document.getElementById('markdownInput').value = '';
            document.getElementById('preview').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 50px 20px;">Nh·∫≠p markdown v√† nh·∫•n "Parse & Preview" ƒë·ªÉ xem tr∆∞·ªõc c√¢u h·ªèi</p>';
            parsedQuestions = [];
            updateStats();
        }

        function loadExample() {
            document.getElementById('markdownInput').value = `## Multiple Choice
# Question: Python l√† ng√¥n ng·ªØ l·∫≠p tr√¨nh g√¨?
- Compiled language
- Interpreted language [100%]
- Assembly language
- Machine language

## True/False
# Question: JavaScript v√† Java l√† c√πng m·ªôt ng√¥n ng·ªØ
- True
- False [100%]

## Short Answer
# Question: Framework ph·ªï bi·∫øn nh·∫•t c·ªßa Python l√† g√¨?
= Django [100%]
= Flask [50%]

## Numerical
# Question: K·∫øt qu·∫£ c·ªßa 10 * 5 + 3 = ?
= 53 [100%]

## Matching
# Question: Gh√©p ng√¥n ng·ªØ v·ªõi m·ª•c ƒë√≠ch s·ª≠ d·ª•ng
@ Python -> Data Science
@ JavaScript -> Web Development
@ SQL -> Database Management
@ C++ -> System Programming

## Calculated
# Question: T√≠nh di·ªán t√≠ch h√¨nh ch·ªØ nh·∫≠t v·ªõi chi·ªÅu d√†i {a} cm v√† chi·ªÅu r·ªông {b} cm
# Formula: {a} * {b}
# Dataset: a=5:15:1, b=3:10:1

## Ordering
# Question: S·∫Øp x·∫øp c√°c b∆∞·ªõc ph√°t tri·ªÉn ph·∫ßn m·ªÅm theo th·ª© t·ª±
> Ph√¢n t√≠ch y√™u c·∫ßu
> Thi·∫øt k·∫ø h·ªá th·ªëng
> L·∫≠p tr√¨nh
> Ki·ªÉm th·ª≠
> Tri·ªÉn khai

## Drag and Drop into Text
# Question: ƒêi·ªÅn t·ª´ v√†o ch·ªó tr·ªëng: [[1]] l√† ng√¥n ng·ªØ ƒë∆∞·ª£c d√πng cho [[2]]
# Choices: Python, JavaScript, Machine Learning, Web Development

## Cloze
# Question: Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† {:SHORTANSWER:=H√† N·ªôi=Ha Noi} v√† c√≥ d√¢n s·ªë kho·∫£ng {:NUMERICAL:=8000000:500000} ng∆∞·ªùi

## Essay
# Question: Gi·∫£i th√≠ch s·ª± kh√°c bi·ªát gi·ªØa OOP v√† Functional Programming (t·ªëi thi·ªÉu 200 t·ª´)

## Description
# Question: ƒê√¢y l√† ph·∫ßn h∆∞·ªõng d·∫´n cho b√†i t·∫≠p l·ªõn. Sinh vi√™n c·∫ßn x√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng web ho√†n ch·ªânh s·ª≠ d·ª•ng React v√† Node.js`;
            parseMarkdown();
        }

        // Auto-parse on page load if there's content
        window.addEventListener('load', () => {
            const input = document.getElementById('markdownInput').value;
            if (input.trim()) {
                parseMarkdown();
            }
            // Initialize visual editor
            updateEditorFields();
        });
    </script>
</body>
</html>
