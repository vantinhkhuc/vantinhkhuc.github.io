<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Chart Pro</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; background: #131722; color: #d1d4dc; font-family: sans-serif; }
        .header { padding: 15px; background: #1c202e; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; border-bottom: 1px solid #2a2e39; }
        #stock-input { padding: 8px; border-radius: 4px; background: #2a2e39; color: white; border: 1px solid #485c7b; text-transform: uppercase; width: 100px; }
        select, button { padding: 8px; border-radius: 4px; cursor: pointer; background: #2a2e39; color: white; border: 1px solid #485c7b; }
        #search-btn { background: #2962ff; border: none; font-weight: bold; }
        .range-btn.active { background: #2962ff; }
        #chart-container { width: 100%; height: calc(100vh - 80px); position: relative; }
        #legend { position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(19, 23, 34, 0.8); padding: 10px; border-radius: 4px; pointer-events: none; }
        .up { color: #26a69a; } .down { color: #ef5350; }
    </style>
</head>
<body>

<div class="header">
    <input type="text" id="stock-input" placeholder="Mã CP">
    <select id="timeframe-select">
        <option value="5m">5 Phút</option>
        <option value="1h">1 Giờ</option>
        <option value="1d" selected>1 Ngày</option>
        <option value="1w">1 Tuần</option>
    </select>
    <button id="search-btn">XEM</button>
    <div class="range-selector">
        <button onclick="window.applyRange(90)">3T</button>
        <button onclick="window.applyRange(180)">6T</button>
        <button onclick="window.applyRange(365)">1N</button>
        <button onclick="window.applyFullRange()">FULL</button>
    </div>
</div>

<div id="chart-container">
    <div id="legend"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('chart-container');
    
    // Khởi tạo biểu đồ
    const chart = LightweightCharts.createChart(container, {
        layout: { background: { color: '#131722' }, textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
        timeScale: { timeVisible: true, secondsVisible: false }
    });

    // SỬA LỖI TẠI ĐÂY: Sử dụng cú pháp mới nếu cần hoặc kiểm tra lại đối tượng chart
    const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
        wickUpColor: '#26a69a', wickDownColor: '#ef5350'
    });

    const volumeSeries = chart.addHistogramSeries({
        priceFormat: { type: 'volume' },
        priceScaleId: 'volume',
    });

    chart.priceScale('volume').applyOptions({
        scaleMargins: { top: 0.8, bottom: 0 },
        visible: false
    });

    // ĐỊNH NGHĨA HÀM ZOOM VÀO ĐỐI TƯỢNG WINDOW ĐỂ HTML GỌI ĐƯỢC
    window.applyRange = (days) => {
        const data = candlestickSeries.data();
        if (!data.length) return;
        const to = data[data.length - 1].time;
        const toDate = (typeof to === 'string') ? new Date(to) : new Date(to * 1000);
        const fromDate = new Date(toDate);
        fromDate.setDate(fromDate.getDate() - days);
        
        const from = (typeof to === 'string') 
            ? fromDate.toISOString().split('T')[0] 
            : Math.floor(fromDate.getTime() / 1000);

        chart.timeScale().setVisibleRange({ from, to });
    };

    window.applyFullRange = () => chart.timeScale().fitContent();

    // Hàm tải dữ liệu
    window.loadData = (ticker) => {
        const tf = document.getElementById('timeframe-select').value;
        const fileName = `./${ticker.toUpperCase()}_${tf}.json`;

        fetch(fileName)
            .then(res => {
                if (!res.ok) throw new Error("Không tìm thấy file " + fileName);
                return res.json();
            })
            .then(data => {
                data.sort((a, b) => (typeof a.time === 'string' ? new Date(a.time) : a.time) - (typeof b.time === 'string' ? new Date(b.time) : b.time));

                candlestickSeries.setData(data.map(d => ({
                    time: d.time, open: d.open, high: d.high, low: d.low, close: d.close
                })));

                volumeSeries.setData(data.map(d => ({
                    time: d.time, value: d.value || d.volume,
                    color: d.close >= d.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)'
                })));

                localStorage.setItem('lastTicker', ticker);
                localStorage.setItem('lastTF', tf);
                chart.timeScale().fitContent();
            })
            .catch(err => alert(err.message));
    };

    // Sự kiện tìm kiếm
    document.getElementById('search-btn').onclick = () => {
        loadData(document.getElementById('stock-input').value.trim());
    };

    // Khởi tạo mã cũ
    const last = localStorage.getItem('lastTicker') || 'VIC';
    const lastTF = localStorage.getItem('lastTF') || '1d';
    document.getElementById('stock-input').value = last;
    document.getElementById('timeframe-select').value = lastTF;
    loadData(last);

    // Resize
    window.onresize = () => chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
});
</script>
</body>
</html>
