<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Chart Pro</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; background: #131722; color: #d1d4dc; font-family: sans-serif; }
        .header { padding: 15px; background: #1c202e; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; border-bottom: 1px solid #2a2e39; }
        #stock-input { padding: 8px; border-radius: 4px; background: #2a2e39; color: white; border: 1px solid #485c7b; text-transform: uppercase; width: 100px; }
        select, button { padding: 8px; border-radius: 4px; cursor: pointer; background: #2a2e39; color: white; border: 1px solid #485c7b; }
        #search-btn { background: #2962ff; border: none; font-weight: bold; }
        .range-btn.active { background: #2962ff; }
        /**#chart-container { width: 100%; height: calc(100vh - 80px); position: relative; }*/
        /*#legend { position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(19, 23, 34, 0.8); padding: 10px; border-radius: 4px; pointer-events: none; }*/
        #legend {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(19, 23, 34, 0.85); /* Nền tối trong suốt */
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #2a2e39;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            pointer-events: none; /* Để không vướng khi kéo biểu đồ */
        }
        .up { color: #26a69a; } .down { color: #ef5350; }

        #chart-container { position: relative; width: 100%; height: calc(100vh - 80px) }
    
        .ohlc-legend {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            background: rgba(19, 23, 34, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none; /* Không cản trở chuột tương tác với biểu đồ */
            display: none; /* Ẩn khi không có dữ liệu */
        }
        .ohlc-item { margin-right: 15px; }
        .up { color: #26a69a; }
        .down { color: #ef5350; }
    </style>
</head>
<body>

<div class="header">
    <input type="text" id="stock-input" placeholder="Mã CP">
    <select id="timeframe-select">
        <option value="5m">5 Phút</option>
        <option value="1h">1 Giờ</option>
        <option value="1d" selected>1 Ngày</option>
        <option value="1w">1 Tuần</option>
    </select>
    <button id="search-btn">XEM</button>
    <div class="range-selector">
        <button onclick="window.applyRange(90)">3T</button>
        <button onclick="window.applyRange(180)">6T</button>
        <button onclick="window.applyRange(365)">1N</button>
        <button onclick="window.applyFullRange()">FULL</button>
    </div>
</div>

<div id="chart-container">
    <div id="legend" class="ohlc-legend"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Kiểm tra xem thư viện đã sẵn sàng chưa
    if (typeof LightweightCharts === 'undefined') {
        console.error("Thư viện LightweightCharts chưa được tải!");
        return;
    }

    const container = document.getElementById('chart-container');
    
    // Khởi tạo biểu đồ
    const chart = LightweightCharts.createChart(container, {
        layout: { 
            background: { color: '#131722' }, 
            textColor: '#d1d4dc' 
        },
        grid: { 
            vertLines: { color: '#2a2e39' }, 
            horzLines: { color: '#2a2e39' } 
        },
        timeScale: { 
            timeVisible: true, 
            secondsVisible: false 
        }
    });

    // Tạo series nến
    const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', 
        downColor: '#ef5350', 
        borderVisible: false,
        wickUpColor: '#26a69a', 
        wickDownColor: '#ef5350'
    });

    // Tạo series volume
    const volumeSeries = chart.addHistogramSeries({
        priceFormat: { type: 'volume' },
        priceScaleId: 'volume',
    });

    // Cấu hình scale cho Volume
    chart.priceScale('volume').applyOptions({
        scaleMargins: { top: 0.8, bottom: 0 },
        visible: false
    });

    // ĐỊNH NGHĨA HÀM ZOOM VÀO ĐỐI TƯỢNG WINDOW ĐỂ HTML GỌI ĐƯỢC
    window.applyRange = (days) => {
        const data = candlestickSeries.data();
        if (!data.length) return;
        const to = data[data.length - 1].time;
        const toDate = (typeof to === 'string') ? new Date(to) : new Date(to * 1000);
        const fromDate = new Date(toDate);
        fromDate.setDate(fromDate.getDate() - days);
        
        const from = (typeof to === 'string') 
            ? fromDate.toISOString().split('T')[0] 
            : Math.floor(fromDate.getTime() / 1000);

        chart.timeScale().setVisibleRange({ from, to });
    };

    window.applyFullRange = () => chart.timeScale().fitContent();

    // Hàm tải dữ liệu
    window.loadData = (ticker) => {
        const tf = document.getElementById('timeframe-select').value;
        const fileName = `./data/${ticker.toUpperCase()}.json`; //_${tf}

        fetch(fileName)
            .then(res => {
                if (!res.ok) throw new Error("Không tìm thấy file " + fileName);
                return res.json();
            })
            .then(data => {
                data.sort((a, b) => (typeof a.time === 'string' ? new Date(a.time) : a.time) - (typeof b.time === 'string' ? new Date(b.time) : b.time));

                // TẠO BIẾN DỮ LIỆU BÊN TRONG KHỐI .THEN
                const candleData = data.map(d => ({
                    time: d.time, 
                    open: parseFloat(d.open), 
                    high: parseFloat(d.high), 
                    low: parseFloat(d.low), 
                    close: parseFloat(d.close)
                }));

                const volumeData = data.map(d => ({
                    time: d.time, 
                    value: parseFloat(d.value || d.volume),
                    color: d.close >= d.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)'
                }));

                // Đưa dữ liệu vào Series
                candlestickSeries.setData(candleData);
                volumeSeries.setData(volumeData);

                // GỌI HÀM CẬP NHẬT LEGEND TẠI ĐÂY (Vì lúc này candleData mới tồn tại)
                const lastCandle = candleData[candleData.length - 1];
                const lastVol = volumeData[volumeData.length - 1].value;
                updateLegend(lastCandle, ticker, lastVol);

                // Lưu vào bộ nhớ (localStorage)
                localStorage.setItem('lastTicker', ticker);
                localStorage.setItem('lastTF', tf);
                
                // --- THAY ĐỔI TẠI ĐÂY: CHỈ HIỂN THỊ 1 NĂM KHI LOAD ---
                if (candleData.length > 0) {
                    const lastDate = candleData[candleData.length - 1].time;
                    let fromDate;

                    // Kiểm tra định dạng thời gian là chuỗi "YYYY-MM-DD" hay timestamp
                    if (typeof lastDate === 'string') {
                        const dateObj = new Date(lastDate);
                        dateObj.setFullYear(dateObj.getFullYear() - 1); // Trừ đi 1 năm
                        fromDate = dateObj.toISOString().split('T')[0];
                    } else {
                        // Nếu là timestamp (số giây)
                        fromDate = lastDate - (365 * 24 * 60 * 60);
                    }

                    // Áp dụng vùng hiển thị (Zoom)
                    chart.timeScale().setVisibleRange({
                        from: fromDate,
                        to: lastDate,
                    });
                }
            })
            .catch(err => alert(err.message));
        
        
    };

    const legend = document.getElementById('legend');

    // Hàm hiển thị thông tin lên Legend
    function updateLegend(candle, ticker, volumeValue) {
        if (!candle) return;
        
        const isUp = candle.close >= candle.open;
        const colorStyle = isUp ? 'color: #26a69a;' : 'color: #ef5350;'; // Xanh hoặc Đỏ
        const change = (candle.close - candle.open).toFixed(2);
        const percent = ((change / candle.open) * 100).toFixed(2);
        const sign = change > 0 ? '+' : '';

        legend.innerHTML = `
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px; ${colorStyle}">
                ${ticker.toUpperCase()} 
                <span style="font-size: 16px; font-weight: normal;">${sign}${percent}%</span>
            </div>
            <div style="color: #848e9c; font-size: 13px; margin-bottom: 5px;">
                Thời gian: <span style="color: #d1d4dc;">${candle.time}</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 20px; font-size: 14px;">
                <div>Mở: <span style="color: #d1d4dc">${candle.open}</span></div>
                <div>Cao: <span style="color: #d1d4dc">${candle.high}</span></div>
                <div>Thấp: <span style="color: #d1d4dc">${candle.low}</span></div>
                <div>Đóng: <span style="color: #d1d4dc">${candle.close}</span></div>
            </div>
            <div style="margin-top: 5px; font-size: 13px; color: #848e9c;">
                Khối lượng: <span style="color: #d1d4dc">${(volumeValue / 1000000).toFixed(2)}M</span>
            </div>
        `;
    }

    // Lắng nghe di chuyển chuột
    chart.subscribeCrosshairMove(param => {
        const ticker = document.getElementById('stock-input').value || 'CP';
    
        // Nếu chuột trong vùng biểu đồ
        if (param.time && param.point && param.point.x >= 0) {
            const candle = param.seriesData.get(candlestickSeries);
            const vol = param.seriesData.get(volumeSeries);
            if (candle) updateLegend(candle, ticker, vol ? vol.value : 0);
        } 
        // Nếu chuột ra ngoài, hiện lại nến cuối cùng
        else {
            const allData = candlestickSeries.data();
            if (allData.length > 0) {
                const last = allData[allData.length - 1];
                const allVol = volumeSeries.data();
                const lastVol = allVol.length > 0 ? allVol[allVol.length - 1].value : 0;
                updateLegend(last, ticker, lastVol);
            }
        }
    });

    

    // Sự kiện tìm kiếm
    document.getElementById('search-btn').onclick = () => {
        loadData(document.getElementById('stock-input').value.trim());
    };

    // Lấy các phần tử giao diện
    const stockInput = document.getElementById('stock-input');
    const searchBtn = document.getElementById('search-btn');

    // Hàm thực hiện tìm kiếm và hiển thị
    function handleSearch() {
        const ticker = stockInput.value.trim().toUpperCase();
        if (ticker) {
            loadData(ticker); // Gọi hàm tải dữ liệu (đã viết ở các bước trước)
            stockInput.blur(); // Ẩn bàn phím/bỏ focus sau khi nhấn Enter
        } else {
            alert("Vui lòng nhập mã cổ phiếu!");
        }
    }

    // Lắng nghe sự kiện nhấn phím Enter trên ô nhập liệu
    stockInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSearch();
        }
    });

    // Lắng nghe sự kiện nhấn nút Tìm kiếm
    searchBtn.addEventListener('click', handleSearch);

    // Khởi tạo mã cũ
    const last = localStorage.getItem('lastTicker') || 'VIC';
    const lastTF = localStorage.getItem('lastTF') || '1d';
    document.getElementById('stock-input').value = last;
    document.getElementById('timeframe-select').value = lastTF;
    loadData(last);

    // Resize
    window.onresize = () => chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
});
</script>
</body>
</html>
